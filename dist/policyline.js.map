{"version":3,"sources":["webpack://policyline/webpack/bootstrap","webpack://policyline/./src/adapter.js","webpack://policyline/./src/expression.js","webpack://policyline/./src/index.js","webpack://policyline/./src/mutator.js","webpack://policyline/./src/operator.js","webpack://policyline/./src/shared.js","webpack://policyline/./src/target.js","webpack://policyline/./src/utils.js"],"names":["optimize","exp","flag","Object","keys","forEach","key","i","length","obj","j","push","splice","MongoJSONb","and","assign","bind","or","a","b","proceed","OperatorMap","MutatorMap","rule","result","attribute","value","context","radius","$near","$geometry","type","coordinates","$maxDistance","rules","mutators","mutator","operator","operators","TYPE","op","val","wrapToToken","item","includes","createTokens","expression","split","map","infixToRPN","queue","stack","precedence","tokens","token","shift","tkPrec","stPrec","pop","fillTokens","data","reduce","prev","next","res","evaluateRPN","rhs","lhs","concat","processRPN","adapter","_property","Symbol","_calcResult","USER","RESOURCE","ENV","ACTION","CONDITION","WATCHER","BOOL","DENY","checkOperand","oper","objStr","isDIObj","indexOf","collectResult","resourceName","targetResults","filterTarget","expr","aggregateResult","policy","resource","dependencyGuard","undefined","error","policyConstructor","Math","random","toString","substr","target","policyParse","groupConstructor","jsonPolicy","policies","prepareFor","propName","_exp","Operator","list","JSON","parse","stringify","left","right","tempObj","reverse","expStr","attributeCheck","attrs","attr","index","Policy","Adapter","hasOwnProperty","call","effect","lastData","missingAttrs","Error","filterType","resultCollection","policyKey","targetExp","floor","substring","tmp","values","mixin","entries","Mutator","extractDate","Date","prefix","postfix","deg2rad","deg","PI","getDistInKm","lat1","lon1","lat2","lon2","R","dLat","dLon","sin","cos","c","atan2","sqrt","leftIsData","leftValue","rightValue","container","parseInt","trim","toUpperCase","toLowerCase","getMinutes","getDate","getHours","getDay","getMonth","getFullYear","position","lastIndexOf","flags","RegExp","register","name","prefixFn","postfixFn","unregister","Array","isArray","namespace","implement","sort","unwrapNamespace","path","part","e","extract","operand","tmpContext","fn","prepareCollection","inputData","leftOperand","rightOperand","replace","leftRegExp","rightRegExp","quote","throwSemanticError","msg","isObjWithAttr","str","unwrapString","parseOperand","array","operandStr","_mutators","slice","parseExp","parts","test","origin","postfixApply","executeExp","rightIsData","isObject","mergeDeep","source"],"mappings":"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","file":"policyline.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","function optimize(exp) {\n  let flag;\n  do {\n    flag = false;\n\n    Object.keys(exp).forEach((key) => {\n      if (key === '$or') {\n        for (let i = exp[key].length - 1; i >= 0; i--) {\n          let obj = exp[key][i];\n          if (obj['$or']) {\n            for (let j = obj['$or'].length - 1; j >= 0; j--) {\n              exp[key].push(obj['$or'][j])\n            }\n            exp[key].splice(i, 1);\n            flag = true;\n          }\n        }\n      } else if (typeof exp[key] === 'object') {\n        exp[key] = optimize(exp[key]);\n      }\n    });\n  } while (flag);\n\n  return exp;\n}\n\nconst MongoJSONb = {\n\n  and: Object.assign.bind(Object),\n\n  or: (a, b) => ({\n    '$or': [a, b]\n  }),\n\n  optimize,\n\n  proceed: rules => {\n    const OperatorMap = {\n      '=': '$eq',\t//Matches values that are equal to a specified value.\n      '==': '$eq', //Matches values that are equal to a specified value.\n      '!=': '$ne', //Matches all values that are not equal to a specified value.\n      '>=': '$gte', //Matches values that are greater than or equal to a specified value.\n      '>': '$gt',\t//Matches values that are greater than a specified value.\n      '<=': '$lte', //Matches values that are less than or equal to a specified value.\n      '<': '$lt',\t//Matches values that are less than a specified value.\n      '~=': '$in', //Matches any of the values specified in an array.\n      '^=': '$nin', //Matches none of the values specified in an array.\n    };\n\n    const MutatorMap = {\n      'or': (rule, result) => {\n        if (!result[rule.attribute]) {\n          result[rule.attribute] = { '$or': [] }\n        }\n\n        result[rule.attribute]['$or'].push(rule.value);\n      },\n      'radius': (rule, result, context) => {\n        context.radius = rule.value;\n      },\n      'inArea': (rule, result, context) => {\n        result[rule.attribute] = {\n          $near: {\n            $geometry: {\n              type: \"Point\",\n              coordinates: rule.value\n            },\n            $maxDistance: 1000 * context.radius,\n          }\n        };\n      }\n    };\n\n    // adapter logic\n    const result = {},\n          context = {};\n    let attribute;\n\n    rules.forEach(rule => {\n      attribute = rule.attribute;\n\n      if (rule.mutators.length) {\n        // apply mutators\n        rule.mutators.forEach((mutator) => {\n          if (MutatorMap[mutator]) {\n            if (!context[attribute]) {\n              context[attribute] = {};\n            }\n            MutatorMap[mutator](rule, result, context[attribute]);\n          }\n        });\n      } else {\n        // apply attribute to result object\n        if (result[attribute]) {\n          result[attribute][OperatorMap[rule.operator]] = rule.value;\n        } else {\n          if (rule.operator === '=') {\n            result[attribute] = rule.value;\n          } else {\n            result[attribute] = {\n              [OperatorMap[rule.operator]]: rule.value\n            }\n          }\n        }\n      }\n    });\n\n    return result;\n  }\n};\n\nexport default { MongoJSONb };","/* based on https://www.barkweb.co.uk/blog/how-to-build-a-calculator-in-javascript */\nconst operators = ['AND', 'OR', '(', ')'];\nconst TYPE = {\n  op: 'OP',\n  val: 'VAL'\n};\n\nconst wrapToToken = item => ({\n  val: item,\n  type: operators.includes(item) ? TYPE.op : TYPE.val\n});\n\nconst createTokens = expression => expression.split(/\\s+|(?=\\(|\\))|\\b/).map(wrapToToken);\n\nconst infixToRPN = tokens => {\n  const queue = [];\n  const stack = [];\n  const precedence = {\n    '(': 10,\n    'AND': 30,\n    'OR': 20\n  };\n\n  while (tokens.length) {\n    const token = tokens.shift();\n    const tkPrec = precedence[token.val] || 0;\n    let stPrec = stack.length ? precedence[stack[stack.length - 1].val] : 0;\n\n    if (token.type === TYPE.op && token.val === ')') {\n      let op = null;\n\n      while ((op = stack.pop()).val !== '(') {\n        queue.push(op);\n      }\n    } else if (token.type === TYPE.val) {\n      queue.push(token);\n    } else if (token.type === TYPE.op && (!stack.length || token.val === '(' || tkPrec > stPrec)) {\n      stack.push(token);\n    } else {\n      while (tkPrec <= stPrec) {\n        queue.push(stack.pop());\n        stPrec = stack.length ? precedence[stack[stack.length - 1].val] : 0;\n      }\n\n      stack.push(token);\n    }\n  }\n\n  while (stack.length) {\n    queue.push(stack.pop());\n  }\n\n  return queue;\n};\n\nconst fillTokens = (tokens, data) => {\n  return tokens.reduce((prev, next) => {\n    const obj = {\n      type: next.type,\n      res: next.res,\n      val: next.val\n    };\n    if (next.type === TYPE.val) {\n      obj.res = data[next.val];\n      obj.val = [next.val];\n    }\n    prev.push(obj);\n    return prev;\n  }, []);\n};\n\nconst evaluateRPN = tokens => {\n  const stack = [];\n  let val;\n\n  while (tokens.length) {\n    const token = tokens.shift();\n\n    if (token.type === TYPE.val) {\n      stack.push(token);\n      continue;\n    }\n\n    const rhs = stack.pop();\n    const lhs = stack.pop();\n\n    switch (token.val) {\n      case 'AND':\n        stack.push({\n          type: TYPE.val,\n          val: (rhs.res && lhs.res) ? lhs.val.concat(rhs.val) : [],\n          res: rhs.res && lhs.res\n        });\n        break;\n      case 'OR':\n        val = [];\n        if (lhs.res) {\n          val = lhs.val;\n        } else if (rhs.res) {\n          val = rhs.val;\n        }\n\n        stack.push({\n          type: TYPE.val,\n          val: val,\n          res: rhs.res || lhs.res\n        });\n        break;\n    }\n  }\n\n  return stack.pop();\n};\n\n\nconst processRPN = (tokens, adapter) => {\n  const stack = [];\n\n  while (tokens.length) {\n    const token = tokens.shift();\n\n    if (token.type === TYPE.val) {\n      stack.push(token);\n      continue;\n    }\n\n    const rhs = stack.pop();\n    const lhs = stack.pop();\n\n    switch (token.val) {\n      case 'OR':\n        if (rhs && lhs && rhs.res && lhs.res) {\n          stack.push({\n            type: TYPE.val,\n            res: adapter.or(rhs.res, lhs.res)\n          });\n        } else {\n          if (rhs && rhs.res) {\n            stack.push(rhs);\n          }\n          if (lhs && lhs.res) {\n            stack.push(lhs);\n          }\n        }\n        break;\n      case 'AND':\n        if (rhs && lhs && rhs.res && lhs.res) {\n          stack.push({\n            type: TYPE.val,\n            res: adapter.and(rhs.res, lhs.res)\n          });\n        }\n        break;\n    }\n  }\n\n  return stack.pop();\n};\n\nexport {\n  processRPN,\n  createTokens,\n  infixToRPN,\n  fillTokens,\n  evaluateRPN,\n  wrapToToken,\n  TYPE\n}","import {parseExp, executeExp, Operator, Mutator} from './target';\nimport {prepareCollection} from './shared';\nimport Adapter from './adapter';\nimport {\n  processRPN,\n  createTokens,\n  infixToRPN,\n  fillTokens,\n  evaluateRPN,\n  wrapToToken,\n  TYPE\n} from './expression';\nimport {mergeDeep} from \"./utils\";\n\nconst _property = Symbol(); // inner property name\nconst _calcResult = Symbol();\nconst USER = 'user.';\nconst RESOURCE = 'resource.';\nconst ENV = 'env.';\nconst ACTION = 'action.';\nconst CONDITION = 'condition';\nconst WATCHER = 'watcher';\nconst BOOL = 'boolean';\nconst DENY = 'deny';\n\nconst checkOperand = (oper, objStr) => {\n  return oper.isDIObj && oper.value.indexOf && oper.value.indexOf(objStr) === 0;\n};\n\nconst collectResult = (obj, data, key, resourceName) => {\n  const context = {}, targetResults = [];\n\n  obj[_property].filterTarget[key].forEach((expr) => {\n    targetResults.push(prepareCollection(data, expr, context, resourceName));\n  });\n\n  return obj.adapter.proceed(targetResults);\n};\n\nconst aggregateResult = (policy, type, data) => {\n  const rules = {},\n        resource = type === CONDITION ? RESOURCE : USER;\n  Object.keys(policy[_property].filterTarget).forEach((key) => {\n    try {\n      rules[key] = collectResult(policy, data, key, resource);\n      if (dependencyGuard(rules[key])) {\n        rules[key] = undefined;\n      }\n    } catch (error) {\n      // important to close error in calculate result\n    }\n  });\n\n  return rules;\n};\n\nconst dependencyGuard = obj  => {\n  let flag = false;\n  Object.keys(obj).forEach((key) => {\n    if (typeof obj[key] === 'string' && (\n      obj[key].indexOf(USER) === 0 ||\n      obj[key].indexOf(RESOURCE) === 0 ||\n      obj[key].indexOf(ENV) === 0 ||\n      obj[key].indexOf(ACTION) === 0\n    )) {\n      flag = true;\n    } else if (typeof obj[key] === 'object') {\n      flag = dependencyGuard(obj[key]);\n    }\n  });\n\n  return flag;\n};\n\nconst policyConstructor = function policyConstructor(policy) {\n  let key = Math.random().toString(36).substr(2, 9);\n  this[_property] = {\n    expression: [wrapToToken(key)],\n    target: {[key]: []},\n    filterTarget: {[key]: []},\n  };\n\n  policyParse(policy, key, this);\n};\n\nconst groupConstructor = function groupConstructor(jsonPolicy) {\n  this[_property] = {\n    expression: infixToRPN(createTokens(jsonPolicy.expression)),\n    target: {},\n    filterTarget: {},\n  };\n\n  Object.keys(jsonPolicy.policies).forEach((key) => {\n    const policy = jsonPolicy.policies[key];\n    this[_property].target[key] = [];\n    this[_property].filterTarget[key] = [];\n\n    policyParse(policy, key, this);\n  });\n};\n\nconst prepareFor = (propName, key, context, _exp) => {\n  const operators = Operator.list;\n  const exp = JSON.parse(JSON.stringify(_exp));\n  const resourceName = propName === WATCHER ? USER : RESOURCE;\n\n  /*\n      We have a restriction; we cannot have a prepared property on both sides of the expression.\n      This contradicts the logic of computation - it makes no sense to compare\n      two different attributes of the same object.\n   */\n  if (checkOperand(exp.left, resourceName)) { // fill if expression in left side\n    context[_property].filterTarget[key].push(exp);\n  } else if (checkOperand(exp.right, resourceName)) { // turn over expression\n    let tempObj = exp.right;\n    exp.right = exp.left;\n    exp.left = tempObj;\n    if (operators[exp.operator].reverse) {\n      exp.operator = operators[exp.operator].reverse;\n    }\n\n    context[_property].filterTarget[key].push(exp);\n  }\n};\n\nconst policyParse = (policy, key, context) => {\n  policy.target\n    .map(expStr => parseExp(expStr))\n    .forEach((_exp) => {\n      context[_property].target[key].push(_exp);\n    });\n};\n\nconst attributeCheck = obj => {\n  const attrs = ['user', 'resource', 'action', 'env'];\n  if (typeof obj === 'object') {\n    Object.keys(obj).forEach((attr) => {\n      const index = attrs.indexOf(attr);\n      if (index > -1) {\n        attrs.splice(index, 1);\n      }\n    });\n  }\n  return attrs;\n};\n\nclass Policy {\n\n  toString() {\n    return this.rules;\n  }\n\n  constructor(jsonPolicy) {\n    this.rules = JSON.stringify(jsonPolicy, null, 2);\n    this.adapter = Adapter.MongoJSONb;\n\n    if (jsonPolicy.hasOwnProperty('target')) {\n      policyConstructor.call(this, jsonPolicy);\n    } else {\n      groupConstructor.call(this, jsonPolicy);\n    }\n\n    this[_property].effect = jsonPolicy.effect !== DENY;\n    this[_property].lastData = null;\n  }\n\n  check(data) {\n    // guard part\n    const missingAttrs = attributeCheck(data);\n    if (missingAttrs.length > 1) {\n      throw new Error(data ? data.toString() : 'empty object' + ' should contain any more than two attributes from: \"user\", \"action\", \"resource\" or \"env\"');\n    }\n\n    this[_calcResult] = {};\n    this[_property].lastData = undefined;\n\n    const filterTarget = missingAttrs[0];\n    this[_property].filterType = filterTarget === 'user' ? WATCHER : CONDITION;\n\n    // clear storage\n    Object.keys(this[_property].target).forEach((key) => {\n      this[_property].filterTarget[key] = [];\n    });\n\n    const resultCollection = {};\n\n    Object.keys(this[_property].target).forEach((policyKey) => {\n      const context = {}, targetResults = {};\n\n      resultCollection[policyKey] = true;\n\n      // calculate separate rules for one policy\n      this[_property].target[policyKey].forEach((targetExp) => {\n        // generate unique random key\n        const key = Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\n        const tmp = executeExp(data, targetExp, context, key, filterTarget);\n\n        if (typeof tmp === BOOL) {\n          targetResults[key] = tmp;\n        } else if (typeof tmp === 'object' && tmp.flag) {\n\n          prepareFor(this[_property].filterType, policyKey, this, targetExp);\n        } else {\n          Object.assign(targetResults, tmp);\n        }\n      });\n\n      // calculate final result for single policy\n      Object.values(targetResults).forEach((value) => {\n        resultCollection[policyKey] = resultCollection[policyKey] && value;\n      });\n    });\n\n    /* fill data for future using */\n    const tokens = fillTokens(this[_property].expression, resultCollection);\n    this[_property].tokens = JSON.parse(JSON.stringify(tokens));\n    this[_calcResult] = evaluateRPN(tokens);\n\n    // apply effect to bool result\n    const result = this[_property].effect ? this[_calcResult].res : !this[_calcResult].res;\n\n    // save data for next `getConditions` methods\n    this[_property].lastData = result ? data : undefined;\n    /**/\n\n    return result;\n  }\n\n  setAdapter(adapter) {\n    this.adapter = adapter;\n  }\n\n  getConditions(mixin) {\n    if ((this[_property].effect ? this[_calcResult].res : !this[_calcResult].res) === false)\n      return undefined;\n\n    const rules = aggregateResult(this, this[_property].filterType, this[_property].lastData);\n\n    let result;\n    if (this[_property].filterType === WATCHER) {\n      // apply results of `check` method\n      this[_property].tokens.forEach((token) => {\n        if (token.type === TYPE.val && token.res === false) {\n          rules[token.val[0]] = undefined;\n        }\n      });\n\n      result = processRPN(fillTokens(this[_property].expression, rules), this.adapter);\n      result = result ? this.adapter.optimize(result.res) : undefined;\n    } else {\n      result = {};\n      Object.entries(rules).forEach(item => {\n        if (this[_calcResult].val.includes(item[0])) {\n          mergeDeep(result, item[1]);\n        }\n      });\n    }\n\n    return mergeDeep(result, mixin);\n  }\n}\n\nexport {\n  Policy,\n  Operator,\n  Mutator,\n  Adapter\n}","const extractDate = a => a instanceof Date ? a : new Date(a);\n\nconst prefix = Symbol();\nconst postfix = Symbol();\n\nconst deg2rad = deg => deg * (Math.PI / 180);\n\nconst getDistInKm = (lat1, lon1, lat2, lon2) => {\n  const R = 6371; // Radius of the earth in km\n  const dLat = deg2rad(lat2 - lat1);  // deg2rad below\n  const dLon = deg2rad(lon2 - lon1);\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2)\n  ;\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c; // Distance in km\n};\n\nconst mutators = {\n  'radius': {\n    [postfix]: (data, context) => {\n      if (data.leftIsData) {\n        context.radius = data.leftValue;\n      } else {\n        context.radius = data.rightValue;\n      }\n\n      return true;\n    }\n  },\n  'inArea': {\n    [postfix]: (data, context) => {\n      return context.radius >= getDistInKm(data.rightValue[0], data.rightValue[1], data.leftValue[0], data.leftValue[1]);\n    }\n  },\n\n  'or': {\n    [postfix]: (data, context, key) => {\n      if (!context.container) {\n        context.container = {};\n      }\n      context.container[key] = data.result;\n\n      if (data.result) {\n        for (let key in context.container) {\n          context.container[key] = true;\n        }\n      }\n\n      return context.container;\n    }\n  },\n\n  'toInt': a => parseInt(a, 10),\n  'toString': a => `${a}`,\n  'trim': a => a.trim(),\n  'uppercase': a => a.toUpperCase(),\n  'lowercase': a => a.toLowerCase(),\n\n  'minute': a => extractDate(a).getMinutes(),\n  'day': a => extractDate(a).getDate(), // according to the local time\n  'hour': a => extractDate(a).getHours(), // according to the local time\n  'weekday': a => extractDate(a).getDay(), // according to the local time\n  'month': a => extractDate(a).getMonth(), // according to the local time\n  'year': a => extractDate(a).getFullYear(), // according to the local time\n\n  'regExp': a => {\n    let position = a.lastIndexOf('/');\n\n    if (position === -1) {\n      position = a.length;\n    }\n\n    const exp = a.substring(0, position);\n    const flags = a.substring(position + 1, a.length);\n    return flags && flags.length ? new RegExp(exp, flags) : new RegExp(exp);\n  }\n};\n\nconst register = (name, prefixFn, postfixFn) => {\n  mutators[name] = {\n    [prefix]: prefixFn,\n    [postfix]: postfixFn\n  }\n};\n\nconst unregister = name => {\n  delete mutators[name];\n};\n\nexport default {\n  prefix,\n  postfix,\n  register,\n  unregister,\n  get list() {\n    return mutators;\n  }\n};","let operators = {\n  '==': {\n    '*': (a, b) => (a === b)\n  },\n  '!=': {\n    '*': (a, b) => (a !== b)\n  },\n  '>=': {\n    '*': (a, b) => (a >= b),\n    reverse: '<='\n  },\n  '<=': {\n    '*': (a, b) => (a <= b),\n    reverse: '>='\n  },\n  '~=': {\n    // contains in array\n    '*': (a, b) => Array.isArray(b) && b.includes(a),\n    reverse: '~!'\n  },\n  '~!': {\n    // contains in array\n    '*': (b, a) => Array.isArray(b) && b.includes(a),\n    reverse: '~='\n  },\n  '^=': {\n    // not contains in array\n    '*': (a, b) => Array.isArray(b) && !b.includes(a),\n    reverse: '^!'\n  },\n  '^!': {\n    // not contains in array\n    '*': (b, a) => Array.isArray(b) && !b.includes(a),\n    reverse: '^='\n  },\n  '?=': {\n    // attribute is absent or equivalent\n    '*': (a, b) => !a || a === b,\n    reverse: '?!'\n  },\n  '?!': {\n    // attribute is absent or equivalent\n    '*': (b, a) => !a || a === b,\n    reverse: '?='\n  },\n  '=': {\n    '*': (a, b) => a === b\n  },\n  '>': {\n    '*': (a, b) => a > b,\n    reverse: '<'\n  },\n  '<': {\n    '*': (a, b) => a < b,\n    reverse: '>'\n  }\n};\n\nconst register = ({name, namespace, implement, reverse}) => {\n  operators[name] = operators[name] || {};\n  operators[name][namespace] = implement;\n  if (namespace === '*' && reverse) {\n    operators[name][namespace].reverse = reverse;\n  }\n\n  // we need to sort the operators from the longest to the shorter ones to avoid interception\n  const obj = {};\n  Object.entries(operators)\n    .sort((a, b) => {\n      if (a[0].length < b[0].length) {\n        return 1;\n      }\n      if (a[0].length > b[0].length) {\n        return -1;\n      }\n\n      return 0;\n    })\n    .forEach(data => {\n      obj[data[0]] = data[1]\n    });\n  operators = obj;\n};\n\nconst unregister = ({name, namespace}) => {\n  let container = operators[name];\n  delete container[namespace];\n\n  if (Object.keys(container).length === 0) {\n    delete operators[name];\n  }\n};\n\nexport default {\n  register,\n  unregister,\n  get list() {\n    return operators;\n  }\n};","import Mutator from \"./mutator\";\n\nconst unwrapNamespace = (data, namespace) => {\n  const path = namespace.split('.');\n  let result = data;\n  for (let part of path) {\n    try {\n      result = result[part];\n    } catch (e) {\n      result = null;\n      break;\n    }\n  }\n  return result;\n};\n\nconst extract = (data, operand, context) => {\n  let value = operand.value;\n  if (operand.isDIObj) {\n    value = unwrapNamespace(data, value)\n  }\n\n  operand.mutators.forEach((mutator) => {\n    let tmpContext, fn;\n    if (operand.isDIObj) {\n      context[operand.value] = context[operand.value] || {};\n      tmpContext = context[operand.value];\n    }\n\n    fn = Mutator.list[mutator];\n    if (fn && typeof fn !== 'function') {\n      fn = fn[Mutator.prefix];\n    }\n\n    value = fn ? fn(value, tmpContext) : value;\n  });\n\n  return value;\n};\n\nconst prepareCollection = (inputData, exp, context, resourceName) => {\n  const leftOperand = extract(inputData, exp.left, context, null);\n  const rightOperand = extract(inputData, exp.right, context, null);\n  let resource = leftOperand === null ? exp.left.value : leftOperand;\n\n  return {\n    attribute: resource.replace(resourceName, ''),\n    value: rightOperand === null ? exp.right.value : rightOperand,\n    operator: exp.operator,\n    mutators: exp.left.mutators\n  };\n};\n\nexport {\n  extract,\n  prepareCollection\n}","import Operator from './operator';\nimport Mutator from './mutator';\nimport {extract} from './shared';\n\nconst leftRegExp = /^[a-zA-Z]+\\.[a-zA-Z]+(?:\\.\\.[a-zA-Z]+)*/;\nconst rightRegExp = /[^\\n]+/;\n\nconst quote = '\\'';\n\nconst throwSemanticError = expr => {\n  const msg = `Semantic Error in ${expr}: \n    Expression should be obj.attr[..mutator](operator)value or object.attribute\n    (user.role~=['admin','user'] , resource.location..radius=100)`;\n  throw new Error(msg);\n};\n\nconst isObjWithAttr = str => {\n  return str.includes('.')\n    && (str.indexOf('user.') === 0\n      || str.indexOf('env.') === 0\n      || str.indexOf('action.') === 0\n      || str.indexOf('resource.') === 0);\n};\n\nconst unwrapString = str => {\n  if (str[0] === quote && str[str.length - 1] === quote) {\n    str = '\"' + str.substr(1, str.length - 2) + '\"';\n  }\n  return str;\n};\n\nconst parseOperand = operandStr => {\n  const array = operandStr.split('..');\n  const _mutators = array.slice(1, array.length);\n  const isDIObj = isObjWithAttr(array[0]);\n  let value;\n\n  try {\n    value = isDIObj ? array[0] : JSON.parse(unwrapString(array[0]));\n  } catch (e) {\n    const msg = `Parsing Error: \\n\\t JSON.parse( ${array[0]} ) in expression`;\n    throw new Error(msg);\n  }\n\n  return {\n    isDIObj,\n    value,\n    mutators: _mutators\n  };\n};\n\nconst parseExp = expStr => {\n  const operators = Operator.list;\n  let operator, parts;\n  for (operator in operators) {\n    parts = expStr.split(operator);\n    if (parts.length === 2) break;\n  }\n\n  if ((parts.length !== 2)\n    || (!leftRegExp.test(parts[0]))\n    || (!rightRegExp.test(parts[1]))) throwSemanticError(expStr);\n\n  return {\n    origin: expStr,\n    left: parseOperand(parts[0]),\n    operator,\n    right: parseOperand(parts[1]),\n  }\n};\n\nconst postfixApply = (operand, data, context, key) => {\n  operand.mutators.forEach((mutator) => {\n    const expr = Mutator.list[mutator];\n    if (operand.isDIObj && typeof expr === 'object' && expr[Mutator.postfix]) {\n      data.result = expr[Mutator.postfix](data, context[operand.value], key);\n    }\n  });\n};\n\nconst executeExp = (inputData, exp, context, key, filterTarget) => {\n  const operators = Operator.list;\n  const leftOperand = extract(inputData, exp.left, context);\n  const rightOperand = extract(inputData, exp.right, context);\n\n  // get correct path to operator implementation\n  let path = '*';\n  if (exp.left.isDIObj && typeof operators[exp.operator][exp.left.value] === 'function') {\n    path = exp.left.value;\n  } else if (exp.right.isDIObj && typeof operators[exp.operator][exp.right.value] === 'function') {\n    path = exp.right.value;\n  }\n\n  const result = operators[exp.operator][path](leftOperand, rightOperand);\n\n  const data = {\n    leftIsData: !exp.left.isDIObj,\n    rightIsData: !exp.right.isDIObj,\n    leftValue: leftOperand,\n    rightValue: rightOperand,\n    result\n  };\n\n  if (filterTarget\n      && ((exp.left.isDIObj && exp.left.value.indexOf(filterTarget) === 0)\n      || (exp.right.isDIObj && exp.right.value.indexOf(filterTarget) === 0))\n  ) {\n    return {\n      flag: true\n    }\n  }\n\n  postfixApply(exp.left, data, context, key);\n  postfixApply(exp.right, data, context, key);\n\n  return data.result;\n};\n\nexport {\n  parseExp,\n  executeExp,\n  Operator,\n  Mutator,\n}","const isObject = item => {\n  return (item\n    && typeof item === 'object'\n    && !Array.isArray(item)\n    && !(item instanceof RegExp));\n};\n\nconst mergeDeep = (target, source) => {\n  if (isObject(target) && isObject(source)) {\n    for (const key in source) {\n      if (isObject(source[key])) {\n        if (!target[key]) {\n          target[key] = {};\n        }\n        mergeDeep(target[key], source[key]);\n      } else {\n        target[key] = source[key];\n      }\n    }\n  }\n  return target || source;\n};\n\nexport { mergeDeep }"],"sourceRoot":""}